<!-- src/app/driver-dashboard/driver-dashboard.page.html -->
<ion-header>
  <ion-toolbar color="primary">
    <div class="sb-nav-fixed">
      <nav class="sb-topnav navbar navbar-expand navbar-dark bg-primary">
        <ion-buttons slot="start">
          <ion-menu-button menu="main-menu" autoHide="false"></ion-menu-button>
        </ion-buttons>
        <a class="navbar-brand ps-3" href="#">Agil Fleet</a>
        <ul class="navbar-nav ms-auto me-3">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle text-white" data-bs-toggle="dropdown">
              <i class="fas fa-user fa-fw"></i> {{ authService.getUserEmail() || 'Conducteur' }}
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" (click)="logout()">Déconnexion</a></li>
            </ul>
          </li>
        </ul>
      </nav>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div class="container-fluid px-4">
    <h1 class="mt-4 h3 text-primary">Tableau de bord</h1>
    <ol class="breadcrumb mb-4"><li class="breadcrumb-item active">Dashboard</li></ol>

    <!-- CARTES RAPIDES -->
    <div class="row g-3 mb-4">
      <div class="col-xl-3 col-lg-6">
        <div class="card border-left-primary shadow h-100 py-2">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col mr-2">
                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Consommation récente</div>
                <div class="h5 mb-0 font-weight-bold text-gray-800">{{ consumptionHistory[0]?.quantity || 0 }} L</div>
              </div>
              <div class="col-auto">
                <ion-icon name="flame" size="large" class="text-primary"></ion-icon>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-lg-6">
        <div class="card border-left-warning shadow h-100 py-2">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col mr-2">
                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Alertes</div>
                <div class="h5 mb-0 font-weight-bold text-gray-800">{{ alerts.length }}</div>
              </div>
              <div class="col-auto">
                <ion-icon name="warning" size="large" class="text-warning"></ion-icon>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ENREGISTREMENT + ANOMALIE -->
    <div class="row">
      <!-- ENREGISTREMENT RAPIDE -->
      <div class="col-lg-8 mb-4">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-success text-white">Enregistrement rapide</div>
          <div class="card-body">
            <form #enregistrerForm="ngForm" (ngSubmit)="recordFuelConsumption(enregistrerForm)">
              <table class="table table-borderless mb-0">
                <tr>
                  <td class="text-end pe-3" style="width: 30%;"><strong>Véhicule *</strong></td>
                  <td>
                    <ion-select [(ngModel)]="selectedVehicleId" name="vehicle" required class="form-control">
                      <ion-select-option *ngFor="let v of vehicles" [value]="v.id">
                        {{ v.licensePlate }} ({{ v.brand }} {{ v.model }})
                      </ion-select-option>
                    </ion-select>
                  </td>
                </tr>
                <tr>
                  <td class="text-end pe-3"><strong>Quantité (L) *</strong></td>
                  <td>
                    <ion-input type="number" [(ngModel)]="quantity" name="quantity" required min="1" placeholder="50" class="form-control"></ion-input>
                  </td>
                </tr>
                <tr>
                  <td class="text-end pe-3"><strong>Date *</strong></td>
                  <td>
                    <ion-input type="date" [(ngModel)]="refuelDate" name="date" required class="form-control"></ion-input>
                  </td>
                </tr>
                <tr>
                  <td class="text-end pe-3"><strong>Coût (optionnel)</strong></td>
                  <td>
                    <ion-input type="number" [(ngModel)]="cost" name="cost" step="0.01" placeholder="75.50" class="form-control"></ion-input>
                  </td>
                </tr>
                <tr>
                  <td class="text-end pe-3"><strong>Kilométrage (optionnel)</strong></td>
                  <td>
                    <ion-input type="number" [(ngModel)]="odometer" name="odometer" placeholder="125000" class="form-control"></ion-input>
                  </td>
                </tr>
                <tr>
                  <td colspan="2" class="text-center">
                    <ion-button type="submit" expand="block" color="success" 
                      [disabled]="!enregistrerForm.valid || !selectedVehicleId || quantity <= 0">
                      Enregistrer
                    </ion-button>
                  </td>
                </tr>
              </table>
              <div class="text-success text-center mt-3" *ngIf="isSuccess">
                {{ fuelMessage }}
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- SIGNALER ANOMALIE -->
      <div class="col-lg-4 mb-4">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-warning text-white">Signaler une anomalie</div>
          <div class="card-body">
            <form #anomalyForm="ngForm" (ngSubmit)="reportAnomaly(anomalyForm)">
              <table class="table table-borderless mb-0">
                <tr>
                  <td class="text-end pe-3" style="width: 40%;"><strong>Description *</strong></td>
                  <td>
                    <ion-input 
                      type="text" 
                      [(ngModel)]="anomalyMessageInput" 
                      name="desc" 
                      required 
                      placeholder="Fuite d'huile" 
                      class="form-control">
                    </ion-input>
                  </td>
                </tr>
                <tr>
                  <td class="text-end pe-3"><strong>Type</strong></td>
                  <td>
                    <ion-select [(ngModel)]="anomalyType" name="type" class="form-control">
                      <ion-select-option value="Panne">Panne</ion-select-option>
                      <ion-select-option value="Consommation">Consommation</ion-select-option>
                      <ion-select-option value="Autre">Autre</ion-select-option>
                    </ion-select>
                  </td>
                </tr>
                <tr>
                  <td colspan="2" class="text-center">
                    <ion-button 
                      type="submit" 
                      expand="block" 
                      color="warning" 
                      [disabled]="!anomalyForm.valid">
                      Signaler
                    </ion-button>
                  </td>
                </tr>
              </table>
              <div class="text-success text-center mt-3" *ngIf="anomalySuccess">
                {{ anomalyMessage }}
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- GRAPHIQUE -->
    <div class="card shadow-sm mb-4">
      <div class="card-header">Consommation hebdomadaire</div>
      <div class="card-body">
        <canvas #consumptionChart height="220"></canvas>
      </div>
    </div>
  </div>
  <app-chatbot></app-chatbot>
</ion-content>